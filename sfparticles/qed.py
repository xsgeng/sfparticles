from numba import njit, prange
from numpy import asarray, full, full_like, log, log10, sqrt, random, zeros
from math import floor
from scipy.constants import alpha, pi, m_e, hbar, c

@njit
def lookup_table_sigmoid(chi_e):
    return

# TODO
_chi_range = (-3, 2) # 0.001-100
_chi_N = 256
_chi_delta = (_chi_range[1] - _chi_range[0]) / (_chi_N - 1)
_prob_rate_table = [0.005231169100489077, 0.005472530588004867, 0.005725017175420045, 0.005989140588888358, 0.00626543601581261, 0.006554463150716805, 0.006856807307559277, 0.007173080581616143, 0.007503923063060073, 0.007850004104443276, 0.00821202364437984, 0.008590713589810854, 0.008986839259327431, 0.009401200890120568, 0.009834635211223406, 0.010288017085810567, 0.010762261225420934, 0.011258323939320755, 0.01177720515939389, 0.012319950153471966, 0.012887651713483377, 0.013481452237450467, 0.014102545941458973, 0.014752181166669659, 0.015431662785138654, 0.016142354708333334, 0.01688568250235439, 0.01766313611399905, 0.018476272711925718, 0.019326719647306832, 0.020216177538484075, 0.021146423484266392, 0.02211931433197067, 0.023136790474709096, 0.02420087901485763, 0.025313697848480924, 0.026477459519555668, 0.02769447530966315, 0.02896715949232393, 0.03029803375760061, 0.03168973181270487, 0.033145004164455, 0.03466672308953308, 0.03625788779858978, 0.0379216298003371, 0.03966121847185842, 0.04148006684144078, 0.043381737590313975, 0.04536994911930519, 0.04744858264461554, 0.049621687947121296, 0.051893490942043374, 0.0542684007172316, 0.056751016985387016, 0.0593461378011967, 0.062058767550034796, 0.06489412521487775, 0.06785765292806087, 0.07095502481447763, 0.0741921561327888, 0.07757521272116137, 0.08111062075401086, 0.08480507681615823, 0.08866555830075322, 0.09269933381006486, 0.09691397551845407, 0.10131736864561393, 0.10591772449104475, 0.11072359222620824, 0.11574387136460897, 0.12098782459822724, 0.12646509100615755, 0.1321856996412804, 0.13816008350078943, 0.14439909388639083, 0.15091401516002786, 0.15771657990103602, 0.16481898447070287, 0.17223390499032795, 0.1799745137390125, 0.18805449531034255, 0.19648806651764508, 0.2052899901473756, 0.2144755957112224, 0.22406079739598425, 0.234062113123032, 0.24449668407815048, 0.2553822947204946, 0.26673739327986246, 0.2785811127520286, 0.2909332924024372, 0.3038144997891632, 0.3172460533166657, 0.33125004533251656, 0.3458493657799707, 0.36106772641991874, 0.376929685636505, 0.3934606738413828, 0.4106870194923093, 0.4286359742531924, 0.4473357462032523, 0.4668155189992427, 0.48710548634652406, 0.5082368799050274, 0.5302420010952169, 0.5531542450450418, 0.5770081405659325, 0.6018393830535187, 0.6276848584840763, 0.6545826866307912, 0.6825722461627208, 0.7116942239849949, 0.7419906386820586, 0.7735048831463534, 0.8062817685110992, 0.8403675564118254, 0.8758100075499353, 0.9126583992554886, 0.9509636134147996, 0.9907781339787765, 1.0321561168826754, 1.0751534304792603, 1.119827706530685, 1.166238369945184, 1.2144467259971519, 1.2645159738976846, 1.3165112779257389, 1.3704998174587915, 1.4265508421805508, 1.4847357287634828, 1.5451280390739952, 1.6078035799506956, 1.6728404646085815, 1.7403191809463727, 1.8103226356472288, 1.8829362516616732, 1.9582480162873142, 2.0363485507775536, 2.1173312061579455, 2.20129211416497, 2.288330230861957, 2.3785475136683707, 2.4720489236549037, 2.568942515854317, 2.6693395469613588, 2.7733545560156356, 2.8811054656464363, 2.992713627777852, 3.108304018161784, 3.2280052394222394, 3.3519496731582175, 3.4802735769683086, 3.613117194607941, 3.750624869681427, 3.8929451630011864, 4.040230986505925, 4.1926396881664685, 4.350333223673168, 4.513478258963728, 4.682246364967487, 4.856814094067663, 5.037363095680773, 5.2240804901152496, 5.417158628894901, 5.6167956931232315, 5.823195542659498, 6.03656803031044, 6.257129152322379, 6.485101233010189, 6.720713115473558, 6.964200358592035, 7.215805440493737, 7.475777989975301, 7.744374919059753, 8.021860772838433, 8.308507877674986, 8.604596576774588, 8.910415572115465, 9.22626208297993, 9.55244197407305, 9.889270426489198, 10.23707189602007, 10.596180429044034, 10.966940048311095, 11.349705027440997, 11.744840208262321, 12.152721369533813, 12.573735399955197, 13.008280892879723, 13.456768340794452, 13.919620547908032, 14.397273011669109, 14.890174267732974, 15.398786540841677, 15.923585715382321, 16.465062092823278, 17.023720736660753, 17.600082358038375, 18.1946825137374, 18.80807394021145, 19.440825500585873, 20.093523547702492, 20.766771852878442, 21.461192718115512, 22.177427573934242, 22.916136954950037, 23.67800157949207, 24.463722851364263, 25.274023499145656, 26.109648316614546, 26.97136458428652, 27.859963040922104, 28.776258406621363, 29.72109041658084, 30.69532439540473, 31.69985196430129, 32.735591777071804, 33.803490557519275, 34.9045245064383, 36.03969863074324, 37.210049455474326, 38.41664471827487, 39.66058487659367, 40.94300400262167, 42.265070815734866, 43.62798987847127, 45.03300216811414, 46.481387098515484, 47.97446272498314, 49.51358773002282, 51.10016222343442, 52.73562899802601, 54.421475177244034, 56.15923364034399, 57.95048327498189, 59.796851745484055, 61.700016862188306, 63.661707215568065, 65.68370444461539, 67.76784468204079, 69.91602022204339, 72.13018123889208, 74.41233777831896, 76.76456071437565, 79.1889848976512, 81.68781030111775, 84.26330416098293, 86.91780281324024, 89.65371482440703, 92.47352215067767, 95.3797812314359, 98.37512854143175, 101.46228090319401, 104.6440375890557, 107.9232837744665, 111.3029928745694]
_prob_rate_table = asarray(_prob_rate_table) * sqrt(3) / 2 / pi * alpha * m_e * c**2/hbar

@njit
def prob_rate_from_chi_e(chi_e):
    log_chi_e = log10(chi_e)
    if log_chi_e < _chi_range[0]:
        return 0.0
    if log_chi_e > _chi_range[1]:
        idx = _chi_N - 1
    if _chi_range[0] < log_chi_e < _chi_range[1]:
        idx = floor((log_chi_e - _chi_range[0]) / _chi_delta)

    log_chi_e_left = _chi_range[0] + idx*_chi_delta
    # linear interp
    k = (_prob_rate_table[idx+1] - _prob_rate_table[idx]) / _chi_delta
    prob_rate = _prob_rate_table[idx] + k * (log_chi_e-log_chi_e_left)

    return prob_rate


# TODO
@njit
def delta_from_chi_delta_table(chi_e):
    return 0

@njit(parallel=True, cache=True)
def lcfa_photon_prob(optical_depth, inv_gamma, chi_e, dt, N):
    event = full(N, False)
    delta = zeros(N)
    for ip in prange(N):
        prob_rate = prob_rate_from_chi_e(chi_e[ip])
        dtau = dt * inv_gamma[ip]
        optical_depth[ip] -= prob_rate * dtau

        if optical_depth[ip] < 0:
            optical_depth[ip] = -log(1 - random.rand())
            event[ip] = True
            delta[ip] = delta_from_chi_delta_table(chi_e[ip])

    return event#, delta
